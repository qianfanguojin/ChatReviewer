import numpy as np
import os
import re
import jieba
from io import BytesIO
import datetime
import time
import openai, tenacity
import argparse
import configparser
import json
import tiktoken
import PyPDF2
import gradio


def contains_chinese(text):
    for ch in text:
        if u'\u4e00' <= ch <= u'\u9fff':
            return True
    return False

def insert_sentence(text, sentence, interval):
    lines = text.split('\n')
    new_lines = []

    for line in lines:
        if contains_chinese(line):
            words = list(jieba.cut(line))
            separator = ''
        else:
            words = line.split()
            separator = ' '

        new_words = []
        count = 0

        for word in words:
            new_words.append(word)
            count += 1

            if count % interval == 0:
                new_words.append(sentence)

        new_lines.append(separator.join(new_words))

    return '\n'.join(new_lines)

# å®šä¹‰Reviewerç±»
class Reviewer:
    # åˆå§‹åŒ–æ–¹æ³•ï¼Œè®¾ç½®å±æ€§
    def __init__(self, api, review_format, paper_pdf, language):
        self.api = api
        self.review_format = review_format

        self.language = language
        self.paper_pdf = paper_pdf
        self.max_token_num = 4096
        self.encoding = tiktoken.get_encoding("gpt2")


    def review_by_chatgpt(self, paper_list):
        text = self.extract_chapter(self.paper_pdf)
        chat_review_text, total_token_used = self.chat_review(text=text)
        return chat_review_text, total_token_used



    @tenacity.retry(wait=tenacity.wait_exponential(multiplier=1, min=4, max=10),
                    stop=tenacity.stop_after_attempt(5),
                    reraise=True)
    def chat_review(self, text):
        openai.api_key = self.api
        review_prompt_token = 1000
        text_token = len(self.encoding.encode(text))
#         input_text_index = int(len(text)*(self.max_token_num-review_prompt_token)/text_token)
        if text_token > self.max_token_num/2 - 800:
            input_text_index = int(len(text)*((self.max_token_num/2)-800)/text_token)
            text = text[:input_text_index]
        input_text = "This is the paper for your review:" + text
        messages=[
                {"role": "system", "content": "You are a professional reviewer. Now I will give you a paper. You need to give a complete review opinion according to the following requirements and format:"+ self.review_format +" Please answer in {}.".format(self.language)},
                {"role": "user", "content": input_text},
        ]

        # openai.api_key = self.api   # è¯»å–api
        # review_prompt_token = 1000
        # try:
        #     text_token = len(self.encoding.encode(text))
        # except:
        #     text_token = 13000
        # input_text_index = int(len(text)*(self.max_token_num-review_prompt_token)/(text_token+1))
        # input_text = "This is the paper for your review:" + text[:input_text_index]
        # messages=[
        #         {"role": "system", "content": "You are a professional reviewer. Now I will give you a paper. You need to give a complete review opinion according to the following requirements and format:"+ self.review_format + "Be sure to use {} answers".format(self.language)} ,
        #         {"role": "user", "content": input_text + " Translate the output into {}.".format(self.language)},
        #     ]
        try:
            #print(self.api)
            #print(openai.api_base)
            print(messages)
            response = openai.ChatCompletion.create(
                model="gpt-3.5-turbo",
                messages=messages,
                temperature=0.7
            )
            result = ''
            for choice in response.choices:
                result += choice.message.content
            result = insert_sentence(result, '**Generated by ChatGPT, no copying allowed!**', 50)
            result += "\n\nâš ä¼¦ç†å£°æ˜/Ethics statementï¼š\n--ç¦æ­¢ç›´æ¥å¤åˆ¶ç”Ÿæˆçš„è¯„è®ºç”¨äºä»»ä½•è®ºæ–‡å®¡ç¨¿å·¥ä½œï¼\n--Direct copying of generated comments for any paper review work is prohibited!"
            usage = response.usage.total_tokens
        except Exception as e:
        # å¤„ç†å…¶ä»–çš„å¼‚å¸¸
            result = "âš ï¼šéå¸¸æŠ±æ­‰>_<ï¼Œç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼š"+ str(e)
            usage  = 'xxxxx'
        print("********"*10)
        print(result)
        print("********"*10)
        return result, usage





    def extract_chapter(self, pdf_path):
        file_object = BytesIO(pdf_path)
        pdf_reader = PyPDF2.PdfReader(file_object)
        # è·å–PDFçš„æ€»é¡µæ•°
        num_pages = len(pdf_reader.pages)
        # åˆå§‹åŒ–æå–çŠ¶æ€å’Œæå–æ–‡æœ¬
        extraction_started = False
        extracted_text = ""
        # éå†PDFä¸­çš„æ¯ä¸€é¡µ
        for page_number in range(num_pages):
            page = pdf_reader.pages[page_number]
            page_text = page.extract_text()

            # å¼€å§‹æå–
            extraction_started = True
            page_number_start = page_number
            # å¦‚æœæå–å·²å¼€å§‹ï¼Œå°†é¡µé¢æ–‡æœ¬æ·»åŠ åˆ°æå–æ–‡æœ¬ä¸­
            if extraction_started:
                extracted_text += page_text
                # åœæ­¢æå–
                if page_number_start + 1 < page_number:
                    break
        return extracted_text

def main(api, share_token, custom_prefix, review_format, paper_pdf, language):
    start_time = time.time()
    comments = ''
    output2 = ''
    if not review_format or not paper_pdf:
        comments =  "âš : å®¡ç¨¿è¦æ±‚æˆ–è®ºæ–‡pdfæœªè¾“å…¥! è¯·æ£€æµ‹! "
        output2 =  "âš : å®¡ç¨¿è¦æ±‚æˆ–è®ºæ–‡pdfæœªè¾“å…¥! è¯·æ£€æµ‹! "
    elif not api and not share_token:
        comments =  "âš : Api æˆ– Share Token é”™è¯¯ï¼è¯·æ£€æµ‹ï¼"
        output2 =  "âš : Api æˆ– Share Token é”™è¯¯ï¼è¯·æ£€æµ‹ï¼"
    else:
        if not api and share_token:
            api = share_token
            openai.api_base = custom_prefix
        # åˆ›å»ºä¸€ä¸ªReaderå¯¹è±¡
        reviewer1 = Reviewer(api, review_format, paper_pdf, language)
        # å¼€å§‹åˆ¤æ–­æ˜¯è·¯å¾„è¿˜æ˜¯æ–‡ä»¶ï¼š
        comments, total_token_used = reviewer1.review_by_chatgpt(paper_list=paper_pdf)
        time_used = time.time() - start_time
        output2 ="ä½¿ç”¨tokenæ•°ï¼š"+ str(total_token_used)+"\nèŠ±è´¹æ—¶é—´ï¼š"+ str(round(time_used, 2)) +"ç§’"
    return comments, output2



########################################################################################################
# æ ‡é¢˜
title = "ğŸ¤–ChatReviewerğŸ¤–"
# æè¿°

description = '''
<strong>ChatRevieweræ˜¯ä¸€æ¬¾åŸºäºChatGPT-3.5çš„APIå¼€å‘çš„æ™ºèƒ½è®ºæ–‡åˆ†æä¸å»ºè®®åŠ©æ‰‹ã€‚</strong>å…¶ç”¨é€”å¦‚ä¸‹ï¼š
â­ï¸å¯¹è®ºæ–‡çš„ä¼˜ç¼ºç‚¹è¿›è¡Œå¿«é€Ÿæ€»ç»“å’Œåˆ†æï¼Œæé«˜ç§‘ç ”äººå‘˜çš„æ–‡çŒ®é˜…è¯»å’Œç†è§£çš„æ•ˆç‡ï¼Œç´§è·Ÿç ”ç©¶å‰æ²¿ã€‚
â­ï¸å¯¹è‡ªå·±çš„è®ºæ–‡è¿›è¡Œåˆ†æï¼Œæ ¹æ®ChatReviewerç”Ÿæˆçš„æ”¹è¿›å»ºè®®è¿›è¡ŒæŸ¥æ¼è¡¥ç¼ºï¼Œè¿›ä¸€æ­¥æé«˜è‡ªå·±çš„è®ºæ–‡è´¨é‡ã€‚
### ä½¿ç”¨æ–¹å¼ï¼š
#### 1. Share Token æ–¹å¼
1. å®˜æ–¹ Chatgpt ç™»å½•ï¼Œç„¶åè®¿é—® [è¿™é‡Œ](http://chat.openai.com/api/auth/session) æ‹¿ Access Tokenã€‚Access Token æœ‰æ•ˆæœŸ 14 å¤©ï¼ŒæœŸé—´è®¿é—®ä¸éœ€è¦æ¢¯å­ã€‚è¿™æ„å‘³ç€ä½ åœ¨æ‰‹æœºä¸Šä¹Ÿå¯éšæ„ä½¿ç”¨ã€‚
2. åˆ° https://ai.fakeopen.com/token å»ç”Ÿæˆä¸€ä¸ªfk-å¼€å¤´çš„Share Tokenã€‚
3. å°†Share Tokenå¡«å…¥è¾“å…¥æ¡†ä¸­ã€‚
4. ä¸Šä¼ è®ºæ–‡PDFæ–‡ä»¶ï¼Œç„¶åç‚¹å‡»Submitã€‚
#### 2. å®˜æ–¹ API æ–¹å¼
1. ç‚¹å‡» [è¿™é‡Œ](https://platform.openai.com/account/api-keys) ç”³è¯·ä¸€ä¸ªOpenAI API Key(sk-xxxx)
2. å¡«å…¥ API-key è¾“å…¥æ¡†ä¸­ã€‚
3. ä¸Šä¼ è®ºæ–‡PDFæ–‡ä»¶ï¼Œç„¶åç‚¹å‡»Submitã€‚

**ä¸¤ç§æ–¹å¼é€‰ä¸€ç§å³å¯ï¼Œå³å¡«äº† API Key å°±ä¸è¦å¡« Share Tokenï¼Œå¡«äº† Share Token å°±ä¸è¦å¡« API Keyã€‚**
åŸé¡¹ç›® [Github](https://github.com/nishiwen1214/ChatReviewer)
'''

# åˆ›å»ºGradioç•Œé¢
inp = [
    gradio.components.Textbox(label="è¯·è¾“å…¥ä½ çš„API-key(skå¼€å¤´çš„å­—ç¬¦ä¸²)",
                          type='password'),
    gradio.components.Textbox(label="è¯·è¾“å…¥ä½ çš„Share Token(fkå¼€å¤´çš„å­—ç¬¦ä¸²)",
                          type='password'),
    gradio.components.Textbox(label="Share Token API-åŸŸå(æ›¿æ¢ https://api.openai.com/v1)",
                          value="https://ai.fakeopen.com/v1/",
                          type='text'),
    gradio.components.Textbox(lines=5,
        label="è¯·è¾“å…¥ç‰¹å®šçš„åˆ†æè¦æ±‚å’Œæ ¼å¼(å¦åˆ™ä¸ºé»˜è®¤æ ¼å¼)",
        value="""* Overall Review
Please briefly summarize the main points and contributions of this paper.
xxx
* Paper Strength
Please provide a list of the strengths of this paper, including but not limited to: innovative and practical methodology, insightful empirical findings or in-depth theoretical analysis,
well-structured review of relevant literature, and any other factors that may make the paper valuable to readers. (Maximum length: 2,000 characters)
(1) xxx
(2) xxx
(3) xxx
* Paper Weakness
Please provide a numbered list of your main concerns regarding this paper (so authors could respond to the concerns individually).
These may include, but are not limited to: inadequate implementation details for reproducing the study, limited evaluation and ablation studies for the proposed method,
correctness of the theoretical analysis or experimental results, lack of comparisons or discussions with widely-known baselines in the field, lack of clarity in exposition,
or any other factors that may impede the reader's understanding or benefit from the paper. Please kindly refrain from providing a general assessment of the paper's novelty without providing detailed explanations. (Maximum length: 2,000 characters)
(1) xxx
(2) xxx
(3) xxx
* Questions To Authors And Suggestions For Rebuttal
Please provide a numbered list of specific and clear questions that pertain to the details of the proposed method, evaluation setting, or additional results that would aid in supporting the authors' claims.
The questions should be formulated in a manner that, after the authors have answered them during the rebuttal, it would enable a more thorough assessment of the paper's quality. (Maximum length: 2,000 characters)
*Overall score (1-10)
The paper is scored on a scale of 1-10, with 10 being the full mark, and 6 stands for borderline accept. Then give the reason for your rating.
xxx"""
    ),
    gradio.components.File(label="è¯·ä¸Šä¼ è®ºæ–‡PDFæ–‡ä»¶(è¯·åŠ¡å¿…ç­‰pdfä¸Šä¼ å®Œæˆåå†ç‚¹å‡»Submitï¼)",type="binary"),
    gradio.components.Radio(choices=["English", "Chinese", "French", "German","Japenese"],
                        value="English",
                        label="é€‰æ‹©è¾“å‡ºè¯­è¨€"),
]

chat_reviewer_gui = gradio.Interface(fn=main,
                                 inputs=inp,
                                 outputs = [gradio.Textbox(lines=40, label="åˆ†æç»“æœ"), gradio.Textbox(lines=2, label="èµ„æºç»Ÿè®¡")],
                                 title=title,
                                 description=description)

# Start server
chat_reviewer_gui .launch(quiet=True, show_api=False)
